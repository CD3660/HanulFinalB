<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="qna">




<!-- 신규 글저장  -->
<insert id="register">

 <selectKey>
	select seq_qna.currval from dual
 </selectKey>

insert into qna ( title, content, writer )
values ( ${title}, #{content}, #{writer} )
</insert>




<!-- 총 글건수 조회 -->
	<select id="totalList" resultType="integer">
	select count(id) from qna <include refid="searchWhere"/>
	</select>


<!-- 검색조건 -->
<sql id="searchWhere">
<choose>
	<!-- 전체  -->
	<when test=" search == 's1' "> 
	where title like '%' || #{keyword} || '%'
	or content  like '%' || #{keyword} || '%'
	or writer in ( select user_id from users where name like '%' || #{keyword} || '%' )
	</when>

	<!-- 제목  -->
	<when test=" search == 's2' ">
	where title like '%' || #{keyword} || '$'
	</when>
	
	<!-- 제목 + 내용  -->
	<when test=" search == 's3' ">
	where title like '%' || #{keyword} || '$'
	or content  like '%' || #{keyword} || '%'
	</when>
	
	<!-- 내용 -->
	<when test=" search == 's3' "> 
	where content like '%' || #{keyword} || '%'
	</when>
	
	<!-- 작성자  -->
	<when test=" search == 's4' ">
	where writer in ( select user_id from users where name like '%' || #{keyword} || '%' )
	</when>

</choose>
</sql>



<!-- 해당페이지의 10건의 정보목록 조회 -->
<select id="list" resultType="qnaVO">
select ( select count(*) from qna_file f where qna_id = q1.id ) filecnt, q1.*
from ( select q.*, name, row_number() over(order by id) no
		from qna q left outer join users u on q.writer = u.user_id <include refid="searchWhere"/> ) q1
where no between #{beginList} and #{endList}
order by no desc

</select>




<!-- 조회수변경 -->
<update id="read">
update qna set readcnt = readcnt + 1
where id = #{id} 
</update>



<!-- 방명록 글정보 조회 -->
<select id="info" resultType="qnaVO">
select *
from qna q left outer join users u
on q.writer = u.user_id
where id =#{id}
</select>



<!-- 첨부파일목록 조회  -->
<select id="fileList" resultType="fileVO">
select * from qna_file where qna_id = #{id}
</select>


<!-- 첨부파일정보 조회 -->
<select id="fileInfo" resultType="fileVO">
select * from qna_file where no = #{no}
</select>



</mapper>